<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta name="generator" content="Gatsby 5.12.5"/><meta name="theme-color" content="#222"/><meta data-react-helmet="true" http-equiv="Permissions-Policy" content="interest-cohort=()"/><meta data-react-helmet="true" name="description" content="Writing a daemon in PHP can be a very attractive prospect.  You already have
your website written, so you have all of this great code already.  You just need
it…"/><meta data-react-helmet="true" property="og:title" content="The Problems with Long Running PHP scripts"/><meta data-react-helmet="true" property="og:description" content="Writing a daemon in PHP can be a very attractive prospect.  You already have
your website written, so you have all of this great code already.  You just need
it…"/><meta data-react-helmet="true" property="og:type" content="website"/><style data-href="/styles.05d2d3bf1a1068e073a9.css" data-identity="gatsby-global-css">@font-face{font-display:swap;font-family:Prociono;font-style:normal;font-weight:400;src:url(/static/prociono-latin-400-normal-9cb330b1c59bd081de660edb7c10b0cb.woff2) format("woff2"),url(/static/prociono-latin-400-normal-b3ba02e5266c660d6d21267bc4a342d0.woff) format("woff");unicode-range:u+00??,u+0131,u+0152-0153,u+02bb-02bc,u+02c6,u+02da,u+02dc,u+0300-0301,u+0303-0304,u+0308-0309,u+0323,u+0329,u+2000-206f,u+2074,u+20ac,u+2122,u+2191,u+2193,u+2212,u+2215,u+feff,u+fffd}code[class*=language-],pre[class*=language-]{word-wrap:normal;background:none;color:#f8f8f2;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;-webkit-hyphens:none;hyphens:none;line-height:1.5;tab-size:4;text-align:left;text-shadow:0 1px rgba(0,0,0,.3);white-space:pre;word-break:normal;word-spacing:normal}pre[class*=language-]{border-radius:.3em;margin:.5em 0;overflow:auto;padding:1em}:not(pre)>code[class*=language-],pre[class*=language-]{background:#272822}:not(pre)>code[class*=language-]{border-radius:.3em;padding:.1em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#8292a2}.token.punctuation{color:#f8f8f2}.token.namespace{opacity:.7}.token.constant,.token.deleted,.token.property,.token.symbol,.token.tag{color:#f92672}.token.boolean,.token.number{color:#ae81ff}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#a6e22e}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url,.token.variable{color:#f8f8f2}.token.atrule,.token.attr-value,.token.class-name,.token.function{color:#e6db74}.token.keyword{color:#66d9ef}.token.important,.token.regex{color:#fd971f}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}</style><style type="text/css">
    .anchor.before {
      position: absolute;
      top: 0;
      left: 0;
      transform: translateX(-100%);
      padding-right: 4px;
    }
    .anchor.after {
      display: inline-block;
      padding-left: 4px;
    }
    h1 .anchor svg,
    h2 .anchor svg,
    h3 .anchor svg,
    h4 .anchor svg,
    h5 .anchor svg,
    h6 .anchor svg {
      visibility: hidden;
    }
    h1:hover .anchor svg,
    h2:hover .anchor svg,
    h3:hover .anchor svg,
    h4:hover .anchor svg,
    h5:hover .anchor svg,
    h6:hover .anchor svg,
    h1 .anchor:focus svg,
    h2 .anchor:focus svg,
    h3 .anchor:focus svg,
    h4 .anchor:focus svg,
    h5 .anchor:focus svg,
    h6 .anchor:focus svg {
      visibility: visible;
    }
  </style><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = window.decodeURI(location.hash.replace('#', ''))
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop
          var clientTop = document.documentElement.clientTop || document.body.clientTop || 0
          var offset = element.getBoundingClientRect().top + scrollTop - clientTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 0)
          }), 0)
        }
      }
    })
  </script><style data-styled="" data-styled-version="6.1.0">html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,img,ins,kbd,q,s,samp,small,strike,strong,sub,sup,tt,var,b,u,i,center,dl,dt,dd,menu,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td,article,aside,canvas,details,embed,figure,figcaption,footer,header,hgroup,main,menu,nav,output,ruby,section,summary,time,mark,audio,video{margin:0;padding:0;border:0;font-size:100%;font:inherit;vertical-align:baseline;}/*!sc*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,menu,nav,section{display:block;}/*!sc*/
*[hidden]{display:none;}/*!sc*/
body{line-height:1;}/*!sc*/
menu,ol,ul{list-style:none;}/*!sc*/
blockquote,q{quotes:none;}/*!sc*/
blockquote:before,blockquote:after,q:before,q:after{content:'';content:none;}/*!sc*/
table{border-collapse:collapse;border-spacing:0;}/*!sc*/
data-styled.g1[id="sc-global-iZuFCm1"]{content:"sc-global-iZuFCm1,"}/*!sc*/
body{font-size:16px;font-family:Prociono,Helvetica,serif;color:#222;font-weight:400;}/*!sc*/
b{font-weight:700;}/*!sc*/
a{color:#222;}/*!sc*/
data-styled.g2[id="sc-global-ibpNQU1"]{content:"sc-global-ibpNQU1,"}/*!sc*/
.fypOJt{list-style:none;display:inline-block;text-transform:uppercase;font-weight:bold;letter-spacing:2px;font-size:12px;line-height:12px;margin:0;}/*!sc*/
.fypOJt a{background-color:#FFF;margin:0 1em;padding:0 0.8em;color:#222;text-decoration:none;}/*!sc*/
.fypOJt a:hover{text-decoration:underline;}/*!sc*/
data-styled.g3[id="layout__NavigationItem-sc-1i3m2x4-0"]{content:"fypOJt,"}/*!sc*/
.SNuPw{position:relative;margin-top:-42px;}/*!sc*/
@media print{.SNuPw{display:none;}}/*!sc*/
data-styled.g4[id="layout__LayoutHeaderContainer-sc-1i3m2x4-1"]{content:"SNuPw,"}/*!sc*/
.jgDFEM{margin-left:auto;margin-right:auto;max-width:50rem;padding:2.625rem 1.3125rem;}/*!sc*/
@page{margin:0 0;}/*!sc*/
@media print{.jgDFEM{max-width:max-content;padding:8mm 10mm!important;margin:0!important;}}/*!sc*/
data-styled.g5[id="layout__LayoutContainer-sc-1i3m2x4-2"]{content:"jgDFEM,"}/*!sc*/
.iAwJBM{line-height:70px;padding-bottom:1.75rem;font-size:50px;font-weight:200;text-transform:uppercase;text-align:center;}/*!sc*/
data-styled.g6[id="layout__LayoutHeaderHeading-sc-1i3m2x4-3"]{content:"iAwJBM,"}/*!sc*/
.jwQtzW{text-decoration:none;color:inherit;margin:0 auto;position:relative;white-space:nowrap;padding-right:30px;}/*!sc*/
data-styled.g7[id="layout__LayoutHeaderHeadingLink-sc-1i3m2x4-4"]{content:"jwQtzW,"}/*!sc*/
.jBzVkH{font-size:12px;position:absolute;top:0;right:-14px;transform:rotate(-90deg);}/*!sc*/
data-styled.g8[id="layout__MyName-sc-1i3m2x4-5"]{content:"jBzVkH,"}/*!sc*/
.fYrKDM{margin-top:8px;margin-bottom:32px;line-height:6px;height:6px;border-bottom:1px solid black;}/*!sc*/
data-styled.g9[id="layout__LayoutNav-sc-1i3m2x4-6"]{content:"fYrKDM,"}/*!sc*/
.ggmFLV{text-align:center;margin:0;padding:0;}/*!sc*/
data-styled.g10[id="layout__LayoutNavList-sc-1i3m2x4-7"]{content:"ggmFLV,"}/*!sc*/
.joLIOQ{font-size:1rem;}/*!sc*/
.joLIOQ p,.joLIOQ ul,.joLIOQ h1,.joLIOQ h2,.joLIOQ h3,.joLIOQ h4,.joLIOQ h5,.joLIOQ h6,.joLIOQ blockquote{margin-bottom:1.5rem;}/*!sc*/
.joLIOQ p:first-child+br{display:none;}/*!sc*/
.joLIOQ p{line-height:1.5rem;}/*!sc*/
.joLIOQ p code{padding:3px 6px;}/*!sc*/
.joLIOQ h1,.joLIOQ h2,.joLIOQ h3,.joLIOQ h4,.joLIOQ h5,.joLIOQ h6{font-size:1.5rem;}/*!sc*/
.joLIOQ blockquote{padding-left:1.75rem;}/*!sc*/
.joLIOQ ul{list-style:'▶';padding-left:0.5rem;}/*!sc*/
.joLIOQ ul li{padding-bottom:0.5rem;padding-left:0.5rem;}/*!sc*/
.joLIOQ .gatsby-highlight{position:relative;margin-bottom:1.75rem;padding:16px 0;border-top:1px solid #222;border-bottom:1px solid #222;}/*!sc*/
.joLIOQ .gatsby-highlight:before{content:"Code";display:inline-block;position:absolute;top:-7px;left:0;text-transform:uppercase;font-size:10px;line-height:12px;padding-right:8px;letter-spacing:2px;background:#FFF;}/*!sc*/
.joLIOQ .gatsby-highlight[data-language]:before{content:attr(data-language);}/*!sc*/
.joLIOQ .gatsby-highlight pre{margin-bottom:0;}/*!sc*/
data-styled.g11[id="markdown__MarkdownContentContainer-sc-hh4cxh-0"]{content:"joLIOQ,"}/*!sc*/
.loVcMV{font-size:16px;position:absolute;display:block;overflow:hidden;width:100px;height:1.2em;top:-0.2em;right:0;margin:0 0 1.75rem;}/*!sc*/
.loVcMV .date,.loVcMV .time{padding-left:8px;background-color:#FFF;position:absolute;right:0;transition:top 0.2s;}/*!sc*/
.loVcMV .date{top:0;}/*!sc*/
.loVcMV .time{top:100%;}/*!sc*/
.loVcMV:hover .date,.loVcMV:focus .date{top:-100%;}/*!sc*/
.loVcMV:hover .time,.loVcMV:focus .time{top:0;}/*!sc*/
data-styled.g12[id="blog-post__BlogPostTimestampContainer-sc-1c33wts-0"]{content:"loVcMV,"}/*!sc*/
.dgChiX{position:relative;height:8px;margin-bottom:36px;border-bottom:1px solid #222;}/*!sc*/
data-styled.g13[id="blog-post__BlogPostHeaderContainer-sc-1c33wts-1"]{content:"dgChiX,"}/*!sc*/
.eLVbfZ{background-color:#FFF;float:left;line-height:14px;font-size:12px;letter-spacing:2px;text-transform:uppercase;padding-right:6px;margin:0;}/*!sc*/
data-styled.g14[id="blog-post__BlogPostHeaderH1-sc-1c33wts-2"]{content:"eLVbfZ,"}/*!sc*/
.ioHvGm{text-decoration:none;}/*!sc*/
.ioHvGm:hover{text-decoration:underline;}/*!sc*/
data-styled.g15[id="blog-post__BlogPostHeaderLink-sc-1c33wts-3"]{content:"ioHvGm,"}/*!sc*/
.lheJAB{display:flex;flex-wrap:wrap;justify-content:space-between;list-style:none;padding:0;}/*!sc*/
data-styled.g19[id="blog-post__BlogPostPaginationUl-sc-155cdgi-0"]{content:"lheJAB,"}/*!sc*/
</style><link rel="icon" href="/favicon-32x32.png?v=db4de95c6680047f2bb2b3b86380467c" type="image/png"/><link rel="manifest" href="/manifest.webmanifest" crossorigin="anonymous"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=db4de95c6680047f2bb2b3b86380467c"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=db4de95c6680047f2bb2b3b86380467c"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=db4de95c6680047f2bb2b3b86380467c"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=db4de95c6680047f2bb2b3b86380467c"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=db4de95c6680047f2bb2b3b86380467c"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=db4de95c6680047f2bb2b3b86380467c"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=db4de95c6680047f2bb2b3b86380467c"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=db4de95c6680047f2bb2b3b86380467c"/><title data-react-helmet="true">The Problems with Long Running PHP scripts | DEFINITIVELY NOT JAMES</title></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div class="layout__LayoutContainer-sc-1i3m2x4-2 jgDFEM"><header class="layout__LayoutHeaderContainer-sc-1i3m2x4-1 SNuPw"><h1 class="layout__LayoutHeaderHeading-sc-1i3m2x4-3 iAwJBM"><a class="layout__LayoutHeaderHeadingLink-sc-1i3m2x4-4 jwQtzW" href="/"><span class="long-word">Definitively</span> Not<span class="layout__MyName-sc-1i3m2x4-5 jBzVkH">( James )</span></a></h1><nav class="layout__LayoutNav-sc-1i3m2x4-6 fYrKDM"><ul class="layout__LayoutNavList-sc-1i3m2x4-7 ggmFLV"><li class="layout__NavigationItem-sc-1i3m2x4-0 fypOJt"><a href="/blog/">Blog</a></li><li class="layout__NavigationItem-sc-1i3m2x4-0 fypOJt"><a href="/resume/">Resume</a></li><li class="layout__NavigationItem-sc-1i3m2x4-0 fypOJt"><a href="/lets-chat/">Let&#x27;s Chat</a></li><li class="layout__NavigationItem-sc-1i3m2x4-0 fypOJt"><a href="/on-my-mind/">On My Mind..</a></li></ul></nav></header><main><article><header class="blog-post__BlogPostHeaderContainer-sc-1c33wts-1 dgChiX"><h1 class="blog-post__BlogPostHeaderH1-sc-1c33wts-2 eLVbfZ"><a aria-current="page" class="blog-post__BlogPostHeaderLink-sc-1c33wts-3 ioHvGm" href="/blog/the-problems-with-long-running-php/">The Problems with Long Running PHP scripts</a></h1><h2 class="blog-post__BlogPostTimestampContainer-sc-1c33wts-0 loVcMV"><span class="date">2014/06/19</span><span class="time">00:51 UTC</span></h2></header><section class="markdown__MarkdownContentContainer-sc-hh4cxh-0 joLIOQ"><p>Writing a daemon in PHP can be a very attractive prospect.  You already have
your website written, so you have all of this great code already.  You just need
it to run and keep track of some data or handle some data as it comes in by
polling a database.  All you do is.. make some infinite loop and..</p>
<div class="gatsby-highlight" data-language="php"><pre style="counter-reset: linenumber NaN" class="language-php line-numbers"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token variable">$databse</span> <span class="token operator">=</span> <span class="token class-name static-context">MyGreatLibrary</span><span class="token operator">::</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token constant boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token variable">$data</span> <span class="token operator">=</span> <span class="token variable">$database</span><span class="token operator">-></span><span class="token function">fetchNewData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">try</span> <span class="token punctuation">{</span>
			<span class="token class-name static-context">MyGreatProcessor</span><span class="token operator">::</span><span class="token function">process</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token variable">$data</span><span class="token operator">-></span><span class="token function">ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> <span class="token variable">$e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token variable">$data</span><span class="token operator">-></span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token function">error_log</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"Error with processor: "</span> <span class="token operator">.</span> <span class="token variable">$e</span><span class="token operator">-></span><span class="token function">getTraceAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Wait for new data</span>
<span class="token punctuation">}</span>
</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>Oh yes.  Beautiful, we’re in business!  What could possibly go wrong?</p>
<h2 id="php-isnt-meant-to-live-forever" style="position:relative;"><a href="#php-isnt-meant-to-live-forever" aria-label="php isnt meant to live forever permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>PHP isn’t meant to live forever</h2>
<p>The biggest reason to let PHP die is that it is the intended use.  It’s a
system primarily designed to handle one request, die, and jump back up again,
resetting itself to a pristine condition - like some sort of ElePHPhoenix.</p>
<p>When you take that glorious death of the process away from it you’re fighting
what makes PHP so useful for the web - how it throws everything away after
each request.  When you try to work around this, and force PHP into roles
that it’s not fit for you’ve subjugated yourself to be tormented.</p>
<p>You also will be bypassing most knowledge that sane developers have
accumulated, and the standard PHP documentation will not be able to save you.
It’s lacking and even non-existant in many cases.</p>
<h2 id="memory-leaks-and-garbage-collection-problems" style="position:relative;"><a href="#memory-leaks-and-garbage-collection-problems" aria-label="memory leaks and garbage collection problems permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Memory Leaks and Garbage Collection Problems</h2>
<p>The largest problem with long running scripts has much to do with PHP’s
<a href="http://www.php.net/manual/en/features.gc.php">garbage collection</a>.  In recent versions it’s become a more advanced
system (version 5.3 and later) but it still can have quirks which may not be at
first the most obvious, especially to those who are used to managing memory on
their own.</p>
<p>This is something exacerbated because PHP itself never frees up memory back to
the operating system to dole out to other processes.  It will only allow it to
be reallocated by other PHP data.  This means that once it does allocate memory
to a PHP process, it continues to hold onto it until the process is ended.</p>
<p>In many cases unset can be invoked and the garbage collection routines will
eventually get to them.  This is done by the internal implementation of
data structures in PHP keeping a <a href="http://php.net/gc.refcounting-basics">reference counter</a>,
incremented at every occurrence of use of the reference, and decremented when
unset.  There are a few cases in which unset does not fully decrement the
reference counter.  One of which is if there is, surprise, a reference to the
data in some other area.  This could be if another object or variable points
to it, which at first thought may be straightforward may not always be easy to
detect.</p>
<div class="gatsby-highlight" data-language="php"><pre style="counter-reset: linenumber NaN" class="language-php line-numbers"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">function</span> <span class="token function-definition function">parse_data</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token variable">$output</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token variable">$output</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'parsed'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">substr</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'foo'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'bar'</span><span class="token punctuation">,</span> <span class="token variable">$data</span><span class="token operator">-></span><span class="token property">data</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token variable">$output</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'original'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$data</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token variable">$variable</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">stdClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$variable</span><span class="token operator">-></span><span class="token property">data</span> <span class="token operator">=</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'large_file.txt'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token variable">$data</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">parse_data</span><span class="token punctuation">(</span><span class="token variable">$variable</span><span class="token punctuation">,</span> <span class="token variable">$arr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">unset</span><span class="token punctuation">(</span><span class="token variable">$variable</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// The references still exist to the zval that $variable pointed at</span>
</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>The other, more devious instance of data remaining in memory is cyclical
references, in that one object refers to another object which refers back to
the original object.  Even when you unset both of the references to the
objects, they still have a reference in that they refer to each other.</p>
<div class="gatsby-highlight" data-language="php"><pre style="counter-reset: linenumber NaN" class="language-php line-numbers"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token variable">$super</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SuperGreat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token variable">$super</span><span class="token operator">-></span><span class="token property">selfReference</span> <span class="token operator">=</span> <span class="token variable">$super</span><span class="token punctuation">;</span>

<span class="token keyword">unset</span><span class="token punctuation">(</span><span class="token variable">$super</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// $super's data continues to stay in memory unless</span>
<span class="token comment">// the garbage collector is enabled</span>
</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>This can be resolved by enabling the more advanced garbage collection available
in PHP 5.3 and later.  This can be done either with the function <code class="language-text">gc_enable()</code>
or the php.ini setting <code class="language-text">zend.gc_enable=1</code>.</p>
<p>Even then, you’re still at the whim of the garbage collector, which will only
collect the unused references when the root buffer fills up.  Thus, calling
<code class="language-text">gc_collect_cycles()</code> may be required in situations where memory is at a
premium.</p>
<p>These issues with memory leaks do not always pertain to just your code,
either.  Many third party PHP libraries can be at fault as well.  If they don’t
follow the same strict rules regarding reference counting and hinting to the
garbage collector that data is available to be collected memory leaks can occur.
This does not get into extensions, which are often never meant to be running for
long periods of time and do have the ability to mismanage memory.  A good
example of this is PHP’s SPL library.</p>
<div class="gatsby-highlight" data-language="php"><pre style="counter-reset: linenumber NaN" class="language-php line-numbers"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">Collection</span> <span class="token keyword">extends</span> <span class="token class-name">ArrayObject</span> <span class="token punctuation">{</span>
	<span class="token keyword">protected</span> <span class="token variable">$iterator</span><span class="token punctuation">;</span>

	<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">getIterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// Well, this is a heavy object to make, let's memoize it</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">iterator</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token variable">$this</span><span class="token operator">-></span><span class="token property">iterator</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayIterator</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">iterator</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token variable">$collection</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Collection</span><span class="token punctuation">(</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'foo'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'bar'</span> <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$collection</span> <span class="token keyword">as</span> <span class="token variable">$item</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">echo</span> <span class="token variable">$item</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">unset</span><span class="token punctuation">(</span><span class="token variable">$collection</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">gc_collect_cycles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Memory from collection is never freed</span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>There was a <a href="https://bugs.php.net/bug.php?id=53803">bug opened</a>, but no resolution aside from manually
destroying the cycles has come of it.  The reason that it happens is because,
as described in the bug, the garbage collector relies on
<a href="https://wiki.php.net/internals/engine/objects#get_properties">get_properties’</a> <code class="language-text">HashTable</code> to know which references
are held by a given object.</p>
<p>In a traditional request PHP cleans up all variables during shut down of the
engine in preparation for the next request.  As a long running script
intends to never shut down and allow that process to happen memory leaks
escalate from being a minor blip to taking down entire servers.</p>
<h2 id="resource-descriptor-limit" style="position:relative;"><a href="#resource-descriptor-limit" aria-label="resource descriptor limit permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Resource Descriptor limit</h2>
<p>When opening a file, a connection to a database using some APIs, or working with
various extensions, you get back a resource instead of an object.  These
resources allow PHP to correctly communicate with the open stream you’ve
instantiated.</p>
<p>Resource Descriptors, however are not a renewable resource in PHP as of the 5.5
release.  The counter is limited to 2^32 - 1.  What should happen is that
the open stream <a href="http://pubs.opengroup.org/onlinepubs/9699919799/functions/open.html">should</a> choose the lowest file descriptor not
currently open.  PHP, however, does not.  Once a resource is opened it can’t
be reused.  Closing it does not send it back to the available pool of
descriptors.  The <a href="https://bugs.php.net/bug.php?id=47396">related bug</a> has been open for nearly 4 years now,
so while it is possible that it’s being worked on, it is even more possible
that it will not be fixed for some time.</p>
<p>However, seeing as there are then roughly 8.6 billion available
descriptors this is unlikely to be much of an issue in most real world
situations.  Just one of the many little problems that exist with running a
PHP script for a long period of time.</p>
<h2 id="other-minor-concerns" style="position:relative;"><a href="#other-minor-concerns" aria-label="other minor concerns permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Other minor concerns</h2>
<p>With long running scripts one of the more lucrative features of PHP doesn’t
come into play, either - how it handles updates.  If PHP never shuts down
the code is never unloaded, and new code is never loaded back in.  This means
that a user would have to manually shut down the worker in some way, usually by
killing the process.  One way to work around this would be to keep track of
when the script was started and compare it against the modified time of the
file, then exiting when it is safe to do so.  Not a pretty way to handle
updates by far.</p>
<p>Many libraries rely on open connections to external services, and for a large
range of reasons that connection could be closed after a long enough time,
especially if the script is sitting in a “waiting” state for a while.
An example of such behavior could be the error message
<code class="language-text">MySQL server has gone away</code>.  This requires boilerplate code to be in place,
verifying that the connection is fresh and available when processing data.</p>
<h2 id="what-can-i-do-about-it" style="position:relative;"><a href="#what-can-i-do-about-it" aria-label="what can i do about it permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>What can I do about it?</h2>
<p>In most cases the need for a long running script just isn’t there.  For some
people, PHP isn’t needed at all, and a language better suited for writing
daemons could be chosen.</p>
<p>There also are many techniques for handling the processing of data in the
background without using long running PHP scripts.  One such would be the use
of job queues and short lived PHP workers started by <a href="http://supervisord.org/">Supervisord</a>,
such as <a href="http://kr.github.io/beanstalkd/">Beanstalkd</a>, <a href="http://gearman.org/">Gearman</a>, or <a href="http://www.celeryproject.org/">Celery</a>.  Many
job queues allow configuration to limit the number of jobs workers will handle
before restarting, thus negating the problems that can crop up.</p>
<p>It’s possible to write long lived PHP daemons.  That doesn’t mean it’s the best
use of anyone’s time, especially yours.</p></section><footer></footer></article><nav><ul class="blog-post__BlogPostPaginationUl-sc-155cdgi-0 lheJAB"><li><a rel="prev" href="/blog/rfc-engine-exceptions/">← <!-- -->RFC: Engine Exception; Erroneous Exceptional Errors</a></li><li><a rel="next" href="/blog/print_r-is-terrible/">print_r is terrible<!-- --> →</a></li></ul></nav></main></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/blog/the-problems-with-long-running-php/";/*]]>*/</script><!-- slice-start id="_gatsby-scripts-1" -->
          <script
            id="gatsby-chunk-mapping"
          >
            window.___chunkMapping="{\"app\":[\"/app-310dda0b9efbee4210dc.js\"],\"component---src-pages-404-js\":[\"/component---src-pages-404-js-9cf2d0f58d9b4d4a791a.js\"],\"component---src-pages-blog-js\":[\"/component---src-pages-blog-js-458ec15ba9ee2cfd0f7a.js\"],\"component---src-pages-index-js\":[\"/component---src-pages-index-js-68a040a6320a8e4a723e.js\"],\"component---src-pages-lets-chat-js\":[\"/component---src-pages-lets-chat-js-381118249cc145fa0e8a.js\"],\"component---src-pages-on-my-mind-js\":[\"/component---src-pages-on-my-mind-js-34cb1637aa152f6dd420.js\"],\"component---src-pages-resume-js\":[\"/component---src-pages-resume-js-6e93062e943f54e86602.js\"],\"component---src-templates-blog-post-js\":[\"/component---src-templates-blog-post-js-bcdb86af6e66fab265ab.js\"],\"component---src-templates-on-my-mind-thought-js\":[\"/component---src-templates-on-my-mind-thought-js-a64e70e65307f5c9c356.js\"]}";
          </script>
        <script>window.___webpackCompilationHash="a93402fe879b43028af0";</script><script src="/webpack-runtime-a1c2a4451d4c5906db3f.js" async></script><script src="/framework-3d39d33798f594700d1d.js" async></script><script src="/app-310dda0b9efbee4210dc.js" async></script><!-- slice-end id="_gatsby-scripts-1" --></body></html>